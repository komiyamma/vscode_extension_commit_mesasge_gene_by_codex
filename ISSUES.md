# プロジェクトの問題点

このドキュメントは、現在のプロジェクト実装における既知の問題点や制約をまとめたものです。

---

## 1. Windows環境への依存

### 概要
現在の実装は、Windows専用の実行ファイル (`codex_proxy.exe`) とコマンドプロンプト (`cmd.exe`)、そして `codex.cmd` というバッチファイルに強く依存しているため、**Windows専用**です。macOSやLinuxなどの他のオペレーティングシステムでは動作しません。

### 詳細
- **実行ファイル:** `src/extension.ts` は `.NET Framework` でコンパイルされた `codex_proxy.exe` を直接呼び出しています。これはWindows環境でしか実行できません。
- **コマンド実行:** `codex_proxy/Program.cs` の内部では、`cmd.exe /c` を使用して `codex.cmd` を呼び出しています。これもWindows固有の機能です。

### クロスプラットフォーム化の困難性について
当初、クロスプラットフォーム化が改善案として挙げられていましたが、その後の調査により、これは現実的ではないと判断されました。
したがって、**本拡張機能は意図的にWindows専用として開発・メンテナンスされる方針**とします。

---

## 2. 柔軟性の欠如（ハードコードされた値）

### 概要
`codex` コマンドへのパス、AIに渡すプロンプト、使用するモデル名などがソースコード内に直接書き込まれて（ハードコードされて）います。これにより、ユーザーが自身の環境に合わせて設定を変更することが困難です。

### 詳細
- **`codex.cmd` のパス:** `codex_proxy/Program.cs` 内で `%APPDATA%\\npm\\codex.cmd` という固定パスで決め打ちされています。ユーザーによってはnpmのグローバルインストール先が異なる場合があります。
- **プロンプト:** コミットメッセージ生成のためのプロンプトがC#ソースコード内に埋め込まれており、内容の変更には再コンパイルが必要です。
- **モデル名:** 使用するモデル名が固定されています。ユーザーが別のモデルを使いたい場合に対応できません。

### 改善案
- VS Codeの`settings.json`で、以下の項目をユーザーが設定できるようにします。
  - `codex.executablePath`: `codex.cmd` の実行パス。
  - `codex.prompt`: プロンプトのテンプレート。
  - `codex.model`: 使用するモデル名。
- これにより、柔軟性とカスタマイズ性が大幅に向上します。

---

## 3. メンテナンス性の問題

### 概要
拡張機能の主要なロジックの一部が、主言語であるTypeScriptとは異なるC#で実装され、コンパイル済みのバイナリとして同梱されています。これにより、コードベースが分断され、メンテナンスや機能追加が煩雑になっています。

### 詳細
- プロジェクトを修正・ビルドするには、TypeScript/Node.js のツールチェーンと、C#/.NET のツールチェーンの両方が必要になります。
- `codex` を呼び出すという中心的な処理がバイナリに隠蔽されているため、挙動の把握やデバッグが困難です。

### (参考) 当初の改善案
当初は `codex_proxy.exe` の機能をTypeScriptに統合する案がありましたが、問題点1で述べた通り、Windows依存は許容する方針となったため、この改善案の優先度は低くなります。ただし、設定を外部ファイルから読み込むなどの改修は、引き続き `codex_proxy` に対して行う必要があります。

---

## 4. 不安定な出力解析

### 概要
AIからの出力を解析し、コミットメッセージを抽出する処理を、`■★■★■` や `▲★▲★▲` といった特殊なマーカー文字列に依存しています。この方法は、AIの応答が少しでも変化すると容易に破綻する可能性があり、非常に不安定です。

### 詳細
- AIが生成する文章内に偶然マーカーと同じ文字列が含まれてしまった場合や、将来的なAIのアップデートで出力形式が変更された場合に、メッセージの抽出に失敗します。

### 改善案
- プロンプトを工夫し、AIにJSON形式で出力させるように指示します。
  - 例: `{ "commitMessage": "..." }`
- 拡張機能側では、受け取った出力をJSONとしてパースします。この方法はマーカー文字列よりもはるかに堅牢で、将来的な拡張も容易になります。

---

## 5. セキュリティ上の懸念

### 概要
`codex` コマンドを実行する際に、`--dangerously-bypass-approvals-and-sandbox` というフラグが常に使用されています。これは潜在的なセキュリティリスクとなり得ます。

### 詳細
- このフラグは、`codex` がファイルシステムの変更やコマンド実行などの危険な操作を、ユーザーの承認なしに行うことを許可します。
- プロンプトによる制約は絶対的なものではなく、悪意のある、あるいは予期せぬ挙動を完全に防ぐことはできません。

### 改善案
- このフラグの使用をデフォルトではやめ、ユーザーがリスクを理解した上でオプトイン形式で有効にできるように、設定項目を追加します。
- 拡張機能の目的（コミットメッセージ生成）を考えると、このフラグは不要である可能性が高いです。

---

## 6. 不親切なエラー処理

### 概要
`codex` コマンドの実行に失敗した場合（例: `codex.cmd` が見つからない）、ユーザーに対して何が問題なのかが分かりやすく提示されません。

### 詳細
- 現在の実装では、エラーはVS Codeの「出力」パネルに表示されるだけです。
- エラーメッセージも技術的な内容であり、具体的な解決策が示されていません。

### 改善案
- `vscode.window.showErrorMessage` APIを使用して、ユーザーにモーダルダイアログでエラーを通知します。
- エラーメッセージには、「'codex.cmd'が見つかりません。PATHを確認するか、設定で実行ファイルのパスを指定してください。」のように、考えられる原因と解決策を具体的に記載します。
